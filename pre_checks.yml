---
- name: Performing Pre-Checks
  hosts: all
  gather_facts: no
  connection: network_cli
  vars:
    ansible_network_os: ios

  tasks:
    - name: Gather CPU usage and free memory
      ios_command:
        commands:
          - "show processes cpu"
      register: output
    
    - name: Show CPU Usage Output
      debug: 
        var: output['stdout'][0] | split('\n')
      when: output is defined

    - name: Assert that IOS device can be upgraded
      assert:
        that:
          - ios == ansible_net_system
          - 1000 < ansible_net_memfree_mb | default('1001') | int
        success_msg: Device is in healthy state.
        fail_msg: Device should be manually verified.
      when: ansible_net_memfree_mb is defined
    
    - assert:
        that:
          - 85 > item.split()[-1] | replace('%', '') | int
        success_msg: Device is in healthy state.
        fail_msg: Device should be manually verified.
      loop: output['stdout'][0] | split('\n')
      when: "'five minutes:' in item"